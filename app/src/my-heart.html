<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="elements/simple-menu.html">
<link rel="import" href="elements/simple-menubar.html">
<link rel="import" href="elements/my-animatable.html">
<link rel="import" href="elements/my-animatable-triangle.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="colors-material.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="elements/paper-slider-custom.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">

<dom-module id="my-heart">

  <template>
<style>
      :host {
        display: block;
        padding: 10px;
        overflow: hidden;
        font-size: 14px;
        height:100%;
      }

    simple-menu,
    simple-menubar {
      display: inline-block;
      width: 100%;
    }

    simple-menu a {
      display: block;
    }

    simple-menubar a,
    simple-menu a {
      padding: 15px 20px;
      color: var(--primary-text-color);
      text-decoration: none;
    }

    paper-time-picker {
        @apply(--layout-center-justified);
        /*@apply(--layout-horizontal);*/
    }

    p.heading {
      color: var(--app-primary-color);
      text-decoration: none;
      margin-bottom:0px;
    }

    simple-menu a[disabled],
    simple-menubar a[disabled] {
      color: var(--google-grey-300);
    }

    .happy {
      --paper-slider-knob-color: var(--paper-yellow-a200);
      --paper-slider-active-color: var(--paper-yellow-a200);
    }
    .sad {
      --paper-slider-knob-color: var(--paper-blue-200);
      --paper-slider-active-color: var(--paper-blue-200);
    }
    .peaceful {
      --paper-slider-knob-color: var(--paper-teal-a200);
      --paper-slider-active-color: var(--paper-teal-a200);
    }
    .anxious {
      --paper-slider-knob-color: var(--paper-purple-200);
      --paper-slider-active-color: var(--paper-purple-200);
    }
    .hopeful {
      --paper-slider-knob-color: var(--paper-orange-a200);
      --paper-slider-active-color: var(--paper-orange-a200);
    }
    .hopeless {
      --paper-slider-knob-color: var(--paper-blue-grey-200);
      --paper-slider-active-color: var(--paper-blue-grey-200);
    }
    .energetic {
      --paper-slider-knob-color: var(--paper-deep-purple-a200);
      --paper-slider-active-color: var(--paper-deep-purple-a200);
    }
    .tired {
      --paper-slider-knob-color: var(--paper-lime-200);
      --paper-slider-active-color: var(--paper-lime-200);
    }
    .confident {
      --paper-slider-knob-color: var(--paper-pink-a200);
      --paper-slider-active-color: var(--paper-pink-a200);
    }
    .insecure {
      --paper-slider-knob-color: var(--paper-green-200);
      --paper-slider-active-color: var(--paper-green-200);
    }
    .relaxed {
      --paper-slider-knob-color: var(--paper-indigo-a200);
      --paper-slider-active-color: var(--paper-indigo-a200);
    }
    .stressed {
      --paper-slider-knob-color: var(--paper-amber-500);
      --paper-slider-active-color: var(--paper-amber-500);
    }
    .grateful {
      --paper-slider-knob-color: var(--paper-purple-a200);
      --paper-slider-active-color: var(--paper-purple-a200);
    }
    .disappointed {
      --paper-slider-knob-color: var(--paper-green-200);
      --paper-slider-active-color: var(--paper-green-200);
    }
    .extroverted {
      --paper-slider-knob-color: var(--paper-red-a200);
      --paper-slider-active-color: var(--paper-red-a200);
    }
    .withdrawn {
      --paper-slider-knob-color: var(--paper-yellow-200);
      --paper-slider-active-color: var(--paper-yellow-200);
    }
    .empathetic {
      --paper-slider-knob-color: var(--paper-light-blue-a200);
      --paper-slider-active-color: var(--paper-light-blue-a200);
    }
    .carefree {
      --paper-slider-knob-color: var(--paper-pink-200);
      --paper-slider-active-color: var(--paper-pink-200);
    }
    .focused {
      --paper-slider-knob-color: var(--paper-blue-a200);
      --paper-slider-active-color: var(--paper-blue-a200);
    }
    .chaotic {
      --paper-slider-knob-color: var(--paper-red-200);
      --paper-slider-active-color: var(--paper-red-200);
    }
    .inspired {
      --paper-slider-knob-color: var(--paper-green-a200);
      --paper-slider-active-color: var(--paper-green-a200);
    }
    .unchallenged {
      --paper-slider-knob-color: var(--paper-indigo-200);
      --paper-slider-active-color: var(--paper-indigo-200);
    }
    .effective {
      --paper-slider-knob-color: var(--paper-deep-orange-a200);
      --paper-slider-active-color: var(--paper-deep-orange-a200);
    }
    .frustrated {
      --paper-slider-knob-color: var(--paper-deep-purple-200);
      --paper-slider-active-color: var(--paper-deep-purple-200);
    }

    #rectangle{
    width:10px;
    height:10px;
    }

    a {
      color: white;
      border-style: solid;
      border-width: 1px;
      font-size: 13px;
      text-align: center;
      margin: 2px;
    }

    paper-button {
      color: white;
      border-style: solid;
      border-width: 1px;
      font-size: 13px;
      text-align: center;
      margin-bottom: 10px;
      --paper-button-raised-keyboard-focus: {
        background-color: var(--paper-pink-a200) !important;
        color: white !important;
      };
    }

    .horizontal-section {
      padding: 0;
      margin-bottom: 20px;
    }

    .row {
      height: 100px;
    }

    .caption {
      padding-left: 12px;
      color: #a0a0a0;
    }

    .menuitem-floating {
      float:left; 
      display:inline;
      margin: 20px;
    }

    .white {
      /*background-color: var(--primary-background-color);*/
    }

    .with-margin {
          margin: 24px 40px;
        }

    .scrollable {
          border: 1px solid lightgray;
          padding: 24px;
          @apply(--layout-scroll);
        }
    .legend {
          padding-right: 45px;
    }
    .legend-title {
          position: relative; 
          top: -15px;
          left: 15px; 
          font-size: 14px;
    }
    </style>

    

        <div>Ratings: <span id="ratingslabel" class="caption"></span></div><br>
        <!-- <div>Happy: <span id="ratingslabel" class="caption"></span></div><paper-slider-custom class="happy" id="happy-ratings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider-custom><br> -->
        <div>Happy: <span id="ratingslabel" class="caption"></span></div><paper-slider class="happy" id="happyRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Sad: <span id="ratingslabel" class="caption"></span></div><paper-slider class="sad" id="sadRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>

        <div>Peaceful: <span id="ratingslabel" class="caption"></span></div><paper-slider class="peaceful" id="peacefulRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>

        <div>Anxious: <span id="ratingslabel" class="caption"></span></div><paper-slider class="anxious" id="anxiousRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Hopeful: <span id="ratingslabel" class="caption"></span></div><paper-slider class="hopeful" id="hopefulRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Hopeless: <span id="ratingslabel" class="caption"></span></div><paper-slider class="hopeless" id="hopelessRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>

        <div>Energetic: <span id="ratingslabel" class="caption"></span></div><paper-slider class="energetic" id="energeticRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Tired: <span id="ratingslabel" class="caption"></span></div><paper-slider class="tired" id="tiredRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Confident: <span id="ratingslabel" class="caption"></span></div><paper-slider class="confident" id="confidentRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Insecure: <span id="ratingslabel" class="caption"></span></div><paper-slider class="insecure" id="insecureRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Relaxed: <span id="ratingslabel" class="caption"></span></div><paper-slider class="relaxed" id="relaxedRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Stressed: <span id="ratingslabel" class="caption"></span></div><paper-slider class="stressed" id="stressedRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>

        <div>Grateful: <span id="ratingslabel" class="caption"></span></div><paper-slider class="grateful" id="gratefulRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Disappointed: <span id="ratingslabel" class="caption"></span></div><paper-slider class="disappointed" id="disappointedRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Extroverted: <span id="ratingslabel" class="caption"></span></div><paper-slider class="extroverted" id="extrovertedRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Withdrawn: <span id="ratingslabel" class="caption"></span></div><paper-slider class="withdrawn" id="withdrawnRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Empathetic: <span id="ratingslabel" class="caption"></span></div><paper-slider class="empathetic" id="empatheticRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Carefree: <span id="ratingslabel" class="caption"></span></div><paper-slider class="carefree" id="carefreeRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>

        <div>Focused: <span id="ratingslabel" class="caption"></span></div><paper-slider class="focused" id="focusedRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Chaotic: <span id="ratingslabel" class="caption"></span></div><paper-slider class="chaotic" id="chaoticRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Inspired: <span id="ratingslabel" class="caption"></span></div><paper-slider class="inspired" id="inspiredRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Unchallenged: <span id="ratingslabel" class="caption"></span></div><paper-slider class="unchallenged" id="unchallengedRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Effective: <span id="ratingslabel" class="caption"></span></div><paper-slider class="effective" id="effectivesRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider><br>
        <div>Frustrated: <span id="ratingslabel" class="caption"></span></div><paper-slider class="frustrated" id="frustratedRatings" pin snaps max="4" max-markers="4" step="1" value="0"></paper-slider>
            

    <firebase-document
        id="activityFirebase"
        app-name="notes"
        path="/"
        data="{{activityDetails}}">
    </firebase-document>
    <firebase-document
        id="createAggregateFirebase"
        app-name="notes"
        path="/"
        data="{{newAggregateDetails}}">
    <firebase-document
        id="updateAggregateFirebase"
        app-name="notes"
        path="/"
        data="{{updateAggregateDetails}}">
    </firebase-document>

    <firebase-document
        id="createTotalFirebase"
        app-name="notes"
        path="/"
        data="{{newTotalData}}">

    <firebase-document
        id="updateTotalFirebase"
        app-name="notes"
        path="/"
        data="{{updateTotalDetails}}">
    </firebase-document>
    <firebase-document
        id="deleteActivityFirebase"
        app-name="notes"
        path="{{pathDelete}}">
    </firebase-document>
    
    <firebase-document
        id="editActivity"
        app-name="notes"
        path="/"
        data="{{editedActivityDetails}}">
    </firebase-document>

    <colors-material id="colorSheet"></colors-material>

  </template>

  <script>

    Polymer({

      is: 'my-heart',

      behaviors: [
        Polymer.NoteAppBehavior
      ],

      properties: {
          datadb: {
          type: Object,
          observer: 'dataChanged'
          },
          user: {
            type: String,
            value: '' 
          },
          periodEndSelected: {
            type: Number,
            value: 0,
            notify: true,
            observer: '_periodEndChanged' 
          },
          periodStartSelected: {
            type: Number,
            value: 0,
            notify: true,
            observer: '_periodStartChanged' 
          },
          activity: {
            type: String,
            reflectToAttribute: true,
            observer: '_activityChanged' 
          },
          activityDetails: {
            type: Object,
            reflectToAttribute: true
          },
          newAggregateDetails: {
            type: Object,
            reflectToAttribute: true
          },
          newTotalData: {
            type: Object,
            reflectToAttribute: true
          }, 
          tempAggregateDetails: {
            type: Object,
            reflectToAttribute: true
          }, 
          tempTotalDetails: {
            type: Object,
            reflectToAttribute: true
          }, 
          aggregatedb: {
            type: Object,
            observer: 'aggregateDetailsChanged'
          },
          editedActivityDetails: {
            type: Object,
            reflectToAttribute: true
          },          
          activityList: {
            type: Array,
            value: [],
            observer: '_activityListChanged' 
          },
          newDayExists: {
            type: Boolean,
            value: false,
          },
          totalDataExists: {
            type: Boolean,
            value: false,
          },
          activities: {
            type: Array,
            value: 
            ["Work1", "Work2", "Sleep", "Personal", "Social", "Exercise", "Errands"]
          },
          firstTime: {
            type: Boolean,
            value: true
          }
      },
      observers: [
           'dataChanged(datadb.*)',
           'aggregateDetailsChanged(aggregatedb.*)',
           'totalDataChanged(totaldb.*)'
      ],
      attached: function() {
        this.date = (new Date()).toDateString();
        
        var happyRatings = this.$.happyRatings;
        happyRatings.addEventListener('value-change', function() {
          console.log("Listener"+happyRatings.value);
        });

        var sadRatings = this.$.sadRatings;
        sadRatings.addEventListener('value-change', function() {
          console.log("Listener"+sadRatings.value);
        });

        var peacefulRatings = this.$.peacefulRatings;
        peacefulRatings.addEventListener('value-change', function() {
          console.log("Listener"+peacefulRatings.value);
        });

        var anxiousRatings = this.$.anxiousRatings;
        anxiousRatings.addEventListener('value-change', function() {
          console.log("Listener"+anxiousRatings.value);
        });

        var hopefulRatings = this.$.hopefulRatings;
        hopefulRatings.addEventListener('value-change', function() {
          console.log("Listener"+hopefulRatings.value);
        });

        var hopelessRatings = this.$.hopelessRatings;
        hopelessRatings.addEventListener('value-change', function() {
          console.log("Listener"+hopelessRatings.value);
        });

        var energeticRatings = this.$.energeticRatings;
        energeticRatings.addEventListener('value-change', function() {
          console.log("Listener"+energeticRatings.value);
        });

        var tiredRatings = this.$.tiredRatings;
        tiredRatings.addEventListener('value-change', function() {
          console.log("Listener"+tiredRatings.value);
        });

        var confidentRatings = this.$.confidentRatings;
        confidentRatings.addEventListener('value-change', function() {
          console.log("Listener"+confidentRatings.value);
        });

        var insecureRatings = this.$.insecureRatings;
        insecureRatings.addEventListener('value-change', function() {
          console.log("Listener"+insecureRatings.value);
        });

        var relaxedRatings = this.$.relaxedRatings;
        relaxedRatings.addEventListener('value-change', function() {
          console.log("Listener"+relaxedRatings.value);
        });

        var stressedRatings = this.$.stressedRatings;
        stressedRatings.addEventListener('value-change', function() {
          console.log("Listener"+stressedRatings.value);
        });

        var gratefulRatings = this.$.gratefulRatings;
        gratefulRatings.addEventListener('value-change', function() {
          console.log("Listener"+gratefulRatings.value);
        });

        var disappointedRatings = this.$.disappointedRatings;
        disappointedRatings.addEventListener('value-change', function() {
          console.log("Listener"+disappointedRatings.value);
        });

        var extrovertedRatings = this.$.extrovertedRatings;
        extrovertedRatings.addEventListener('value-change', function() {
          console.log("Listener"+extrovertedRatings.value);
        });

        var withdrawnRatings = this.$.withdrawnRatings;
        withdrawnRatings.addEventListener('value-change', function() {
          console.log("Listener"+withdrawnRatings.value);
        });

        var empatheticRatings = this.$.empatheticRatings;
        empatheticRatings.addEventListener('value-change', function() {
          console.log("Listener"+empatheticRatings.value);
        });

        var carefreeRatings = this.$.carefreeRatings;
        carefreeRatings.addEventListener('value-change', function() {
          console.log("Listener"+carefreeRatings.value);
        });

        var focusedRatings = this.$.focusedRatings;
        focusedRatings.addEventListener('value-change', function() {
          console.log("Listener"+focusedRatings.value);
        });

        var chaoticRatings = this.$.chaoticRatings;
        chaoticRatings.addEventListener('value-change', function() {
          console.log("Listener"+chaoticRatings.value);
        });

        var inspiredRatings = this.$.inspiredRatings;
        inspiredRatings.addEventListener('value-change', function() {
          console.log("Listener"+inspiredRatings.value);
        });

        var unchallengedRatings = this.$.unchallengedRatings;
        unchallengedRatings.addEventListener('value-change', function() {
          console.log("Listener"+unchallengedRatings.value);
        });

        var effectiveRatings = this.$.effectiveRatings;
        effectiveRatings.addEventListener('value-change', function() {
          console.log("Listener"+effectiveRatings.value);
        });

        var frustratedRatings = this.$.frustratedRatings;
        frustratedRatings.addEventListener('value-change', function() {
          console.log("Listener"+frustratedRatings.value);
        });

      },
      aggregateDetailsChanged: function(aggregatedb) {
        console.log("aggregatedb: ");
        console.log(this.aggregatedb);
        var aggregateData = this.aggregatedb;
        this.tempAggregateDetails = {}; 
        var that = this;
        aggregateData.forEach(function(childSnapshot) {
          var key = childSnapshot.$key;
          if (key === "activities") {
          that.tempAggregateDetails.activities = {};
            for (var i=0; i<that.activities.length;i++) {
              var activityName = that.activities[i];
              that.tempAggregateDetails.activities[activityName] = childSnapshot[activityName];
            }
          }
        });
        this.oldAggregateDetails = this.tempAggregateDetails;
        console.log("updateAggregateDetails");
        console.log(this.oldAggregateDetails);
      },
      preventScrolling: function(event) {
        event.preventDefault();
      },
      totalDataChanged: function(totaldb) {
        console.log("totaldb: ");
        console.log(this.totaldb);
        var totalData = this.totaldb;
        this.tempTotalDetails = {}; 
        var that = this;
        totalData.forEach(function(childSnapshot) {
          var key = childSnapshot.$key;
          if (key === "activities") {
          that.tempTotalDetails.activities = {};
            for (var i=0; i<that.activities.length;i++) {
              var activityName = that.activities[i];
              that.tempTotalDetails.activities[activityName] = childSnapshot[activityName];
            }
          }
        });
        this.oldTotalData = this.tempTotalDetails;
        console.log("updateAggregateDetails");
        console.log(this.oldTotalData);
      },
      dataChanged: function (datadb) {
        var activityColors = 
        { "Sleep": {"colorShade": "Teal", "colorType": "A200"},
          "Work1" : {"colorShade": "Blue", "colorType": "A200"},
          "Work2" : {"colorShade": "Purple", "colorType": "A200"},
          "Exercise" : {"colorShade": "Orange", "colorType": "A200"},
          "Social" : {"colorShade": "Pink", "colorType": "A200"},
          "Errands" : {"colorShade": "Purple", "colorType": "A200"},
          "Personal": {"colorShade": "Green", "colorType": "A200"}
        };
        var that = this;
        // do something when the query returns values
        console.log("---BEFORE");
        var data = this.datadb;
        var localDataAster = [];
        var colorSheet = this.$.colorSheet;
        data.forEach(function(childSnapshot) {
          console.log("my input");
          console.log(childSnapshot);
          // key will be "fred" the first time and "barney" the second time
          var activityLabel = childSnapshot.activityType;
          var startTime = childSnapshot.startTime;
          var endTime = childSnapshot.endTime;
          var colorShadeString = activityColors[activityLabel].colorShade;
          var activitySelectedColor = colorSheet.colors[colorShadeString].a700;
        });
        console.log("AFTER");
      },
      createNewTotalData: function() {
        console.log("createNewTotalData");
        this.newTotalData = {};
        this.newTotalData.numDays = 0;
        this.newTotalData.activities = {};
        for (var i=0; i<this.activities.length;i++) {
          //TODO: WHY IS activity 0
          console.log(this.activities[i]);
          this.newTotalData.activities[this.activities[i]] = 0;
        }
        console.log(this.newTotalData);
        this.oldTotalData = this.newTotalData;
      },
      createNewAggregateActivity: function() {
        this.newAggregateDetails = {};
        this.newAggregateDetails.activities = {};
        for (var i=0; i<this.activities.length;i++) {
          //TODO: WHY IS activity 0
          console.log(this.activities[i]);
          this.newAggregateDetails.activities[this.activities[i]] = 0;
        }
        console.log("createNewAggregateActivity");
        console.log(this.newAggregateDetails);
        this.oldAggregateDetails = this.newAggregateDetails;

        var tempUpdateTotalDetails = this.oldTotalData;
        tempUpdateTotalDetails.numDays = parseInt(this.oldTotalData.numDays) + 1;
        console.log("AFTER this.updateAggregateDetails.activities[this.activity]");
        this.updateTotalDetails = tempUpdateTotalDetails;
        this.oldTotalData = this.updateTotalDetails;
        this.updateTotal();
      },
      _periodStartChanged: function(periodStartSelected) {
        
        },
      _activityListChanged: function(activityList) {
        console.log("activityList: "+this.activityList);
      },
      saveEntry: function(emotionName, value) {  
        if (this.$.activityFirebase.isNew) {
          var that = this;
          return this.$.activityFirebase.save(this.user+"/daily/"+(new Date()).toDateString()+"/emotions/").then(function() {
            that.$.activityFirebase.reset();
          });
        }
        return Promise.resolve();
      },
      createTotal: function() {  
        console.log("creating new aggregate day");
        if (this.$.createTotalFirebase.isNew) {
          var that = this;
          return this.$.createTotalFirebase.save(this.user,"total").then(function() {
            that.$.createTotalFirebase.reset();
          });
        }
        return Promise.resolve();
      },
      updateTotal: function() { 
      console.log("update new aggregate day"); 
        if (this.$.updateTotalFirebase.isNew) {
          var that = this;
          return this.$.updateTotalFirebase.save(this.user, "total").then(function() {
            that.$.updateTotalFirebase.reset();
          });
        }
        return Promise.resolve();
      },
      createDayAggregate: function() {  
        console.log("creating new aggregate day");
        if (this.$.createAggregateFirebase.isNew) {
          var that = this;
          return this.$.createAggregateFirebase.save(this.user+"/aggregate",(new Date()).toDateString()).then(function() {
            that.$.createAggregateFirebase.reset();
          });
        }
        return Promise.resolve();
      },
      updateNewDayAggregate: function() { 
      console.log("update new aggregate day"); 
        if (this.$.updateAggregateFirebase.isNew) {
          var that = this;
          return this.$.updateAggregateFirebase.save(this.user+"/aggregate", (new Date()).toDateString()).then(function() {
            that.$.updateAggregateFirebase.reset();
          });
        }
        return Promise.resolve();
      },
      editOldEntry: function(emotionName) {  
        if (this.$.editActivity.isNew) {
          var that = this;
          return this.$.editActivity.save(this.user+"/daily/"+(new Date()).toDateString()+"/emotions/"+emotionName).then(function() {
            that.$.editActivity.reset();
          });
        }
        return Promise.resolve();
      },
      _activityChanged: function(activitySelected) {
        console.log("_activityChanged: "+this.activity);
        },
      _periodEndChanged: function(periodEndSelected) {
        console.log("_periodEndChanged");
        console.log("this.firstTime: "+this.firstTime);
        
        if (this.firstTime) {
          this.createPopUp();
        }
        
        
        },
      createPopUp: function() {
        this.$.plain.open();
      },
      _closePopUp: function() {
        console.log("close");
        this.$.plain.close();
      },
      _saveSelection: function() {
        var heartColors = 
        { "Happy": {"colorShade": "Yellow", "colorType": "A200"},
          "Sad" : {"colorShade": "Blue", "colorType": "200"},
          "Peaceful" : {"colorShade": "Teal", "colorType": "A200"},
          "Anxious" : {"colorShade": "Purple", "colorType": "200"},
          "Hopeful" : {"colorShade": "Orange", "colorType": "A200"},
          "Hopeless" : {"colorShade": "BlueGrey", "colorType": "200"}
        };
        var bodyColors = 
        { "Energetic": {"colorShade": "DeepPurple", "colorType": "A200"},
          "Tired" : {"colorShade": "Lime", "colorType": "200"},
          "Confident" : {"colorShade": "Pink", "colorType": "A200"},
          "Insecure" : {"colorShade": "Green", "colorType": "200"},
          "Relaxed" : {"colorShade": "Indigo", "colorType": "A200"},
          "Stressed" : {"colorShade": "Amber", "colorType": "200"}
        };
        var spiritColors = 
        { "Grateful": {"colorShade": "Purple", "colorType": "A200"},
          "Disappointed" : {"colorShade": "Green", "colorType": "200"},
          "Extroverted" : {"colorShade": "Red", "colorType": "A200"},
          "Withdrawn" : {"colorShade": "Yellow", "colorType": "200"},
          "Empathetic" : {"colorShade": "LightBlue", "colorType": "A200"},
          "Carefree" : {"colorShade": "Pink", "colorType": "200"}
        };
        var mindColors = 
        { "Focused": {"colorShade": "Yellow", "colorType": "A200"},
          "Chaotic" : {"colorShade": "Blue", "colorType": "200"},
          "Inspired" : {"colorShade": "Teal", "colorType": "A200"},
          "Unchallenged" : {"colorShade": "Purple", "colorType": "200"},
          "Effective" : {"colorShade": "Orange", "colorType": "A200"},
          "Frustrated" : {"colorShade": "BlueGrey", "colorType": "200"}
        };
        console.log("activity: " +this.activity);
        console.log("SAVE SELECTION");
        this.activityDetails.activityType = this.activity;
        this.activityDetails.startTime = this.periodStartSelected;
        this.activityDetails.endTime = this.periodEndSelected;
        this.activityDetails.duration = this.periodEndSelected - this.periodStartSelected;
        
        this.activityList.push(this.activityDetails);
        var activitySelected = this.activity;
        // console.log("activitySelected: "+activitySelected);
        var colorShadeString = activityColors[activitySelected].colorShade;
        // console.log("colorShadeString: "+colorShadeString);
        var activitySelectedColor = this.$.colorSheet.colors[colorShadeString].a700;
        this.searchDb();
        
        console.log("newDayExists: "+this.newDayExists);

        if (!this.totalDataExists) {
          this.createNewTotalData();
          console.log("creating new total - first time user");
        }

        if (!this.newDayExists) {
          this.createNewAggregateActivity();
        }
        
        var tempPlaceUpdateAggregateDetails = this.oldAggregateDetails;
        console.log("this.oldAggregateDetails");
        console.log(this.oldAggregateDetails);
        tempPlaceUpdateAggregateDetails.activities[this.activity] = parseInt(this.oldAggregateDetails.activities[this.activity]) + this.activityDetails.duration;
        
        this.updateAggregateDetails = tempPlaceUpdateAggregateDetails;
        this.oldAggregateDetails = this.updateAggregateDetails;

        console.log("tempPlaceUpdateAggregateDetails");
        console.log(this.tempPlaceUpdateAggregateDetails);
        this.updateNewDayAggregate();

        var tempUpdateTotalDetails = this.oldTotalData;
        console.log("oldTotalData");
        console.log(this.oldTotalData);
        tempUpdateTotalDetails.activities[this.activity] = parseInt(this.oldTotalData.activities[this.activity]) + this.activityDetails.duration;        
        this.updateTotalDetails = tempUpdateTotalDetails;
        this.oldTotalData = this.updateTotalDetails;
        console.log("update total");
        console.log(this.updateTotalDetails);
        console.log("tempUpdateTotalDetails");
        console.log(this.tempUpdateTotalDetails);
        this.updateTotal();

        this.saveEntry();

        // console.log("ENTRY SAVED AND BEFORE UPDATE NEW AGGREGATE");
        // this.updateNewDayAggregate();
        // console.log("UPDATED NEW AGGREGATE AND BEFORE CLOSING POP UP");
        this._closePopUp();
      },
      updateAggregateActivity: function() {
        this.updateAggregateDetails.activities[this.activity] += this.activityDetails.duration;
        this.updateNewDayAggregate();
      },
      editTotal: function (diffDuration, diffActivityName) {
        var tempUpdateTotalDetails = this.oldTotalData;
        tempUpdateTotalDetails.activities[diffActivityName] = parseInt(this.oldTotalData.activities[diffActivityName]) + diffDuration;
        this.updateTotalDetails = tempUpdateTotalDetails;
        this.oldTotalData = this.updateTotalDetails;
        console.log("update total");
        console.log(this.updateTotalDetails);
        this.updateTotal();
      },
      editAggregate: function (diffDuration, diffActivityName) {
        var tempPlaceUpdateAggregateDetails = this.oldAggregateDetails;
        tempPlaceUpdateAggregateDetails.activities[diffActivityName] = parseInt(this.oldAggregateDetails.activities[diffActivityName]) + diffDuration;

        
        this.updateAggregateDetails = tempPlaceUpdateAggregateDetails;
        this.oldAggregateDetails = this.updateAggregateDetails;
        this.updateNewDayAggregate();
      },
      searchDb: function() {
        // console.log("SEARCH DB");
        // console.log(this.datadb);

        for (key in this.datadb) {
          var obj = this.datadb[key];
          console.log("obj");
          console.log(obj);

          var activityStartTime = obj.startTime;
          var activityEndTime = obj.endTime;
          var oldDuration = obj.endTime - obj.startTime;
          var newDuration = oldDuration;

          var diffActivityName = obj.activityType;

          var modified = false;
          var deleted = false;
          if (activityStartTime < this.periodEndSelected && activityEndTime > this.periodEndSelected) {
            //change start time of the old activity
            obj.startTime = this.periodEndSelected;
            newDuration = obj.endTime - obj.startTime;
            diffDuration = newDuration - oldDuration;
            console.log("MODIFYING START TIME");
            modified = true;
          }
          else if (activityStartTime < this.periodStartSelected && activityEndTime > this.periodStartSelected) {
            // change end time of old activity
            obj.endTime = this.periodStartSelected;
            newDuration = obj.endTime - obj.startTime;
            diffDuration = newDuration - oldDuration;
            console.log("MODIFYING END TIME");
            modified = true;
          }
          else if (activityEndTime <= this.periodEndSelected && activityStartTime >= this.periodStartSelected) {
            // delete this key
            var key = obj.$key;
            diffDuration = - oldDuration;
            this.delete(key);
            deleted = true;
            console.log("DELETING");
          }

          if (modified) {
            console.log("obj");
            this.editedActivityDetails.activityType = obj.activityType;
            this.editedActivityDetails.startTime = obj.startTime;
            this.editedActivityDetails.endTime = obj.endTime;
            this.editedActivityDetails.duration = obj.endTime - obj.startTime;
            
            console.log("editedActivityDetails");
            console.log(this.editedActivityDetails);
            var key = obj.$key;
            this.editOldEntry(key);
          }
          if (modified || deleted) {
            this.editAggregate(diffDuration, diffActivityName); //TODO
            this.editTotal(diffDuration, diffActivityName); //TODO
          }
        }
      },
      printEndValue: function() {
        console.log("printEndValue: "+this.periodEndSelected);
      },
    });

  </script>

</dom-module>
