<link rel="import" href="../../bower_components/polymer/polymer.html">
<script type="text/javascript" src="../d3.min.js"></script>
<link rel="import" href="../colors-material.html">

<dom-module id="polymer-area-chart">

  <template>
    <colors-material id="colorSheet"></colors-material>
    <div id="bodyBig" class="bodyBig">
      <div id="chart" class="chart"></div>
    </div>
      <style>
      .bodyBig {
        font: 10px sans-serif;
      }

      .chart { 
        background: #fff;
      }

      p {
        font: 12px helvetica;
      }


      .axis path, .axis line {
        fill: none;
        stroke: #000;
        stroke-width: 2px;
        shape-rendering: crispEdges;
      }

      button {
        position: absolute;
        right: 50px;
        top: 10px;
      }


    </style>

  </template>

  <script>
    Polymer({

      is: 'polymer-area-chart',
      properties: {
        emotions: {
          type: Array,
          value: 
          ["joy", "calm", "hope", "sorrow", "anger", "fear"]
        },
        positiveNegativeEmotion: {
          type: Object,
          value: 
          {"joy": 1, "calm" : 1, "hope": 1, "sorrow": -1, "anger": -1, "fear": -1}
        },
        activities: {
          type: Array,
          value: 
          ["Work", "Sleep", "Leisure", "Social", "Gym"]
        },
        aggregatedb: {
          type: Object,
          observer: 'aggregateDetailsChanged'
        },
        emotionColors: {
          type: Object,
          value: 
          { "joy": {"colorShade": "Lime", "colorType": "a400"},
          "calm": {"colorShade": "Cyan", "colorType": "a400"},
          "fear" : {"colorShade": "Orange", "colorType": "a700"},
          "anger" : {"colorShade": "Red", "colorType": "a700"},
          "sorrow" : {"colorShade": "Yellow", "colorType": "a700"},
          "hope": {"colorShade": "Teal", "colorType": "a400"}
          }
        },
        activityColors: {
          type: Object,
          value: 
          { "Sleep": {"colorShade": "Green", "colorType": "a200"},
          "Work" : {"colorShade": "Blue", "colorType": "a200"},
          "Gym" : {"colorShade": "Pink", "colorType": "a200"},
          "Social" : {"colorShade": "Amber", "colorType": "a200"},
          "Leisure": {"colorShade": "Purple", "colorType": "a200"}
          }
        },
        data: {
          type: Array,
          value: []
        }
      },
      getActivityColor: function(activityName) {
          var colorSheet = this.$.colorSheet;
          var colorShadeString = this.activityColors[activityName].colorShade;
          var colorGradientString = this.activityColors[activityName].colorType;
          var selectedColor = colorSheet.colors[colorShadeString][colorGradientString];
          return selectedColor;        
      },
      getEmotionColor: function(emotionName){
          var colorSheet = this.$.colorSheet;
          var colorShadeString = this.emotionColors[emotionName].colorShade;
          var colorGradientString = this.emotionColors[emotionName].colorType;
          var selectedColor = colorSheet.colors[colorShadeString][colorGradientString];
          return selectedColor;
      },
      readyProduce: function() {
        /*eslint-disable */

        // create dataset
        var names = (this.activities).concat(this.emotions);
        var endTime = Date.now();
        console.log("SEE THIS: "+this.getBoundingClientRect().width);
        // this.$.chart.style.width = 0.9 * this.getBoundingClientRect().width;
        var month = 30 * 24 * 60 * 60 * 1000;
        var week = 7 * 24 * 60 * 60 * 1000;
        var day = 24 * 60 * 60 * 1000;
        var startTime = endTime - day;
        var activityColorsList = [];

        for (var i = 0; i < this.activities.length; i++) {
          activityColorsList.push(this.getActivityColor(this.activities[i]));
        }
        var emotionColorsList = [];
        for (var i = 0; i < this.emotions.length; i++) {
          emotionColorsList.push(this.getEmotionColor(this.emotions[i]));
        }
        var color  = (activityColorsList).concat(emotionColorsList);
        // for (var i = 0; i < names.length; i++) {
        //     data.push(createEmptyEvent(names[i]));
        // }
        console.log("DEFINING COLOR");
        console.log(color);

        var datearray = [];
        var colorrange = [];

        color = "orange";

        if (color == "blue") {
          colorrange = ["#045A8D", "#2B8CBE", "#74A9CF", "#A6BDDB", "#D0D1E6", "#F1EEF6"];
        }
        else if (color == "pink") {
          colorrange = ["#980043", "#DD1C77", "#DF65B0", "#C994C7", "#D4B9DA", "#F1EEF6"];
        }
        else if (color == "orange") {
          colorrange = ["#B30000", "#E34A33", "#FC8D59", "#FDBB84", "#FDD49E", "#FEF0D9"];
        }
        strokecolor = colorrange[0];

        var format = d3.time.format("%m/%d/%y");

        var margin = {top: 20, right: 40, bottom: 30, left: 30};
        var width = this.getBoundingClientRect().width - margin.left - margin.right;
        var height = 400 - margin.top - margin.bottom;

        d3.select(this.$.chart).selectAll("*").remove();
        
        var tooltip = d3.select(this.$.bodyBig)
            .append("div")
            .attr("class", "remove")
            .style("position", "absolute")
            .style("z-index", "20")
            .style("visibility", "hidden")
            .style("top", "30px")
            .style("left", "55px");

        var x = d3.time.scale()
            .range([0, width]);

        var y = d3.scale.linear()
            .range([height-10, 0]);

        var z = d3.scale.ordinal()
            .range(colorrange);

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom")
            .ticks(d3.time.weeks);

        var yAxis = d3.svg.axis()
            .scale(y);

        var yAxisr = d3.svg.axis()
            .scale(y);

        var stack = d3.layout.stack()
            .offset("silhouette")
            .values(function(d) { return d.values; })
            .x(function(d) { return d.date; })
            .y(function(d) { return d.value; });

        var nest = d3.nest()
            .key(function(d) { return d.key; });

        var area = d3.svg.area()
            .interpolate("cardinal")
            .x(function(d) { return x(d.date); })
            .y0(function(d) { return y(d.y0); })
            .y1(function(d) { return y(d.y0 + d.y); });

        var svg = d3.select(this.$.chart)
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var data = [{ "key": "AR", "value": 0.1, "date": "01/08/13"},
          { "key": "AR", "value": 0.1, "date": "02/08/13"},
          { "key": "AR", "value": 0.1, "date": "03/08/13"},
          { "key": "DJ", "value": 0.1, "date": "01/08/13"},
          { "key": "DJ", "value": 0.1, "date": "02/08/13"},
          { "key": "DJ", "value": 0.1, "date": "03/08/13"},
          { "key": "MS", "value": 0.1, "date": "01/08/13"},
          { "key": "MS", "value": 0.1, "date": "02/08/13"},
          { "key": "MS", "value": 0.1, "date": "03/08/13"},
          { "key": "RC", "value": 0.1, "date": "01/08/13"},
          { "key": "RC", "value": 0.1, "date": "02/08/13"},
          { "key": "RC", "value": 0.1, "date": "03/08/13"},
          { "key": "CG", "value": 0.1, "date": "01/08/13"},
          { "key": "CG", "value": 0.1, "date": "02/08/13"},
          { "key": "CG", "value": 0.1, "date": "03/08/13"}];

        
          data.forEach(function(d) {
            d.date = format.parse(d.date);
            d.value = +d.value;
          });
          console.log("data");
          console.log(data);
          console.log(nest.entries(data));
          var layers = stack(nest.entries(data));

          x.domain(d3.extent(data, function(d) { return d.date; }));
          y.domain([0, d3.max(data, function(d) { return d.y0 + d.y; })]);

          svg.selectAll(".layer")
              .data(layers)
            .enter().append("path")
              .attr("class", "layer")
              .attr("d", function(d) { return area(d.values); })
              .style("fill", function(d, i) { return z(i); });


          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis);

          svg.append("g")
              .attr("class", "y axis")
              .attr("transform", "translate(" + width + ", 0)")
              .call(yAxis.orient("right"));

          svg.append("g")
              .attr("class", "y axis")
              .call(yAxis.orient("left"));

          svg.selectAll(".layer")
            .attr("opacity", 1)
            .on("mouseover", function(d, i) {
              svg.selectAll(".layer").transition()
              .duration(250)
              .attr("opacity", function(d, j) {
                return j != i ? 0.6 : 1;
            })})

            .on("mousemove", function(d, i) {
              mousex = d3.mouse(this);
              mousex = mousex[0];
              var invertedx = x.invert(mousex);
              invertedx = invertedx.getMonth() + invertedx.getDate();
              var selected = (d.values);
              for (var k = 0; k < selected.length; k++) {
                datearray[k] = selected[k].date
                datearray[k] = datearray[k].getMonth() + datearray[k].getDate();
              }

              mousedate = datearray.indexOf(invertedx);
              pro = d.values[mousedate].value;

              d3.select(this)
              .classed("hover", true)
              .attr("stroke", strokecolor)
              .attr("stroke-width", "0.5px"), 
              tooltip.html( "<p>" + d.key + "<br>" + pro + "</p>" ).style("visibility", "visible");
              
            })
            .on("mouseout", function(d, i) {
             svg.selectAll(".layer")
              .transition()
              .duration(250)
              .attr("opacity", "1");
              d3.select(this)
              .classed("hover", false)
              .attr("stroke-width", "0px"), tooltip.html( "<p>" + d.key + "<br>" + pro + "</p>" ).style("visibility", "hidden");
          })
            
          var vertical = d3.select(this.$.chart)
                .append("div")
                .attr("class", "remove")
                .style("position", "absolute")
                .style("z-index", "19")
                .style("width", "1px")
                .style("height", "380px")
                .style("top", "10px")
                .style("bottom", "30px")
                .style("left", "0px")
                .style("background", "#fff");

          d3.select(this.$.chart)
              .on("mousemove", function(){  
                 mousex = d3.mouse(this);
                 mousex = mousex[0] + 5;
                 vertical.style("left", mousex + "px" )})
              .on("mouseover", function(){  
                 mousex = d3.mouse(this);
                 mousex = mousex[0] + 5;
                 vertical.style("left", mousex + "px")});
        
        
      },

    });
  </script>

</dom-module>
