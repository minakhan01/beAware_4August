<link rel="import" href="../../bower_components/polymer/polymer.html">
<script type="text/javascript" src="../../d3/d3.min.js"></script>
<!-- <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script> -->
<script type="text/javascript" src="../tool-tip.js"></script>

<dom-module id="aster-polymer">
  <template>
    <style>
      :host {
                /*display: block;*/
                height: 1000px;
                width: 1000px;
                font: 10px sans-serif;
            }
.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
polyline{
  opacity: .3;
  stroke: black;
  stroke-width: 2px;
  fill: none;
}
.bar {
  fill: orange;
}

.solidArc {
    -moz-transition: all 0.3s;
    -o-transition: all 0.3s;
    -webkit-transition: all 0.3s;
    transition: all 0.3s;
}

.solidArc:hover {
  fill: orangered ;
}

.solidArcDonut {
    -moz-transition: all 0.3s;
    -o-transition: all 0.3s;
    -webkit-transition: all 0.3s;
    transition: all 0.3s;
}

.solidArcDonut:hover {
  fill: greenyellow ;
}

.x.axis path {
  display: none;
}

.aster-score { 
  line-height: 1;
  font-weight: bold;
  font-size: 500%;
}

#tooltip {
    position: fixed;
    /*width: 10px;*/
    line-height: 1;
    padding: 12px;
    background: rgba(255, 255, 255, 0.8);
    -webkit-border-radius: 2px;
    -moz-border-radius: 2px;
    border-radius: 2px;
    /*-webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
    -mox-box-shadow: 4px 4px 4px 10px rgba(0, 0, 0, 0.4);
    box-shadow: 4px 4px 10px rbga(0, 0, 0, 0.4) pointer-events: none;*/
}
#tooltip.hidden {
    opacity: 0;
}
#tooltip p {
    margin: 0;
    font-family: sans-serif;
    font-size: 16px;
    line-height: 14px;
}
    </style>
     <div id="full">
    <svg id="svg"></svg>
        <div id="tooltip" style="opacity:0;"><p><span id="valueNode">100</span></p></div>
      </div>
  </template>
  <script>
    Polymer({
      /* this is the element's prototype */
      is: 'aster-polymer',
      properties: {
        data: {
          type: Array,
          value: [
          { "name": "one", "score": 10, "width": 2, "color": "#9E0041"},
          { "name": "two", "score": 20, "width": 2, "color": "#C32F4B"},
          { "name": "three", "score": 40, "width": 5, "color": "#E1514B"},
          { "name": "four", "score": 10, "width": 4, "color": "#F47245"},
          { "name": "five", "score": 5, "width": 6, "color": "#FB9F59"}],
          observer: 'dataChanged'
        },
        queryDone: {
          type: Boolean,
          value : false
        },
      }, 
      observers: [
           'dataChanged(data.splices)'
      ],
      dataChanged : function() {
        console.log("data changed in ASTER_POLYMER");
        this.createElements();
      },
      createElements: function () {
        var svg = d3.select(this.$.svg);
        svg.selectAll("*").remove();
	var width = 600,
    height = 600,
    radius = Math.min(width, height) / 2 - 70,
    innerRadius = 0.3 * radius;

var pie = d3.pie()
    .sort(null)
    .value(function(d) { return d.width; });

        var tooltipNode = d3.select(this.$.tooltip);
        var valueNode = d3.select(this.$.valueNode);
        var fullNode = d3.select(this.$.full);

var tip = d3tip()
  .attr('class', 'd3-tip')
  .offset([0, 0])
  .html(function(d) {
    return d.data.name + ": <span style='color:orangered'>" + d.data.score + "</span>";
  });

var arc = d3.arc()
  .innerRadius(innerRadius)
  .outerRadius(function (d) { 
    return (radius - innerRadius) * (Math.abs(d.data.score) / 10.0) + innerRadius; 
  });

var arcDonut = d3.arc()
  .innerRadius(radius)
  .outerRadius(radius+50);

var outlineArc = d3.arc()
        .innerRadius(innerRadius)
        .outerRadius(radius);

var svg = d3.select(this.$.svg)
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

svg.call(tip);
  
  var printThis = [{ "name": "one", "score": 40, "width": 2, "color": "#9E0041"},
          { "name": "two", "score": 20, "width": 2, "color": "#C32F4B"},
          { "name": "three", "score": 40, "width": 5, "color": "#E1514B"},
          { "name": "four", "score": 10, "width": 4, "color": "#F47245"},
          { "name": "five", "score": 5, "width": 6, "color": "#FB9F59"}];

  data = this.data;
  console.log("data");
  console.log(data);
  console.log("dummy data");
  console.log(printThis);

  var path = svg.selectAll(".solidArc")
      .data(pie(data))
    .enter().append("path")
      .attr("fill", function(d) { 
        if (d.data.score < 0)
          return "#aa0000";
        else
          return "#00aa00" })
      .attr("class", "solidArc")
      .attr("stroke", "gray")
      .attr("d", arc)
      .on('mouseover', function (d) {
        console.log("d3.event.pageX: "+d3.event.pageX);
        console.log("d3.mouse(this): "+d3.mouse(this));
        console.log("d3.event.pageY: "+d3.event.pageY);
        tooltipNode
        .style("left", d3.event.pageX + "px")
        .style("top", d3.event.pageY + "px")        
        // .style("left", d3.mouse(fullNode)[0] + "px")
        // .style("top", d3.mouse(fullNode)[1] + "px")
        .style("opacity", 1);
        valueNode
        .text(d.data.score);
      })
      .on('mouseout', function () {
            tooltipNode
        .style("opacity", 0);;
      });

  var pathDonut = svg.selectAll(".solidArcDonut")
      .data(pie(data))
    .enter().append("path")
      .attr("fill", function(d) { return d.data.color; })
      .attr("class", "solidArcDonut")
      .attr("stroke", "gray")
      .attr("d", arcDonut);

  var outerPath = svg.selectAll(".outlineArc")
      .data(pie(data))
    .enter().append("path")
      .attr("fill", "none")
      .attr("stroke", "gray")
      .attr("class", "outlineArc")
      .attr("d", outlineArc);  

  svg.append("text")
      .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
      .attr("dy", ".35em")
      .text(function(d) { return "d.data.name;" });

  // calculate the weighted mean score
  var score = 
    data.reduce(function(a, b) {
      //console.log('a:' + a + ', b.score: ' + b.score + ', b.weight: ' + b.weight);
      return a + (b.score * b.width); 
    }, 0) / 
    data.reduce(function(a, b) { 
      return a + b.width; 
    }, 0);

  svg.append("svg:text")
    .attr("class", "aster-score")
    .attr("dy", ".35em")
    .attr("text-anchor", "middle") // text-align: right
    .text(Math.round(score));

  // svg.append("text")
  //   .attr("x", radius + 6)
  //   .attr("dy", ".35em")
  //   .style("text-anchor", function(d) { return d < 270 && d > 90 ? "end" : null; })
  //   .attr("transform", function(d) { return d < 270 && d > 90 ? "rotate(180 " + (radius + 6) + ",0)" : null; })
  //   .text(function(d) { return d + "Â°"; });

      },
      ready: function () {
              this.createElements();
            },

    });
  </script>
</dom-module>