<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/app-storage/app-network-status-behavior.html">
<link rel="import" href="colors-material.html">
<link rel="import" href="elements/polymer-area-chart.html">

<dom-module id="my-analysis">

  <template>
    <style></style>
    <colors-material id="colorSheet"></colors-material>
    <polymer-area-chart id="charts" data="[[data]]"></polymer-area-chart>

  </template>

  <script>

    Polymer({

      is: 'my-analysis',
      properties: {
        user: {
            type: String,
            value: '' 
          },
        dailydb: {
          type: Object,
          observer: 'dataChanged'
          },
        allVariables: {
          type: Array,
          value: ["happy", "sad", "peaceful", "anxious", "hopeful", "hopeless", "energetic", "tired", "confident", "insecure", "relaxed", "stressed", "grateful", "disappointed", "extroverted", "withdrawn", "empathetic", "carefree", "focused", "chaotic", "inspired", "unchallenged", "effective", "frustrated", "Work1", "Work2", "Sleep", "Exercise", "Social", "Personal", "Errands"]
        },
        data: {
          type: Array,
          value: []
        },
        emotions: {
          type: Array,
          value: 
          ["happy", "sad", "peaceful", "anxious", "hopeful", "hopeless", "energetic", "tired", "confident", "insecure", "relaxed", "stressed", "grateful", "disappointed", "extroverted", "withdrawn", "empathetic", "carefree", "focused", "chaotic", "inspired", "unchallenged", "effective", "frustrated"]
        },
        activities: {
          type: Array,
          value: 
          ["Work1", "Work2", "Sleep", "Exercise", "Social", "Personal", "Errands"]
        },
        names: {
          type: Array,
          value: []
        },
        emotionColors: {
          type: Object,
          value: 
          { "happy": {"colorShade": "Yellow", "colorType": "A200"},
            "sad" : {"colorShade": "Blue", "colorType": "200"},
            "peaceful" : {"colorShade": "Teal", "colorType": "A200"},
            "anxious" : {"colorShade": "Purple", "colorType": "200"},
            "hopeful" : {"colorShade": "Orange", "colorType": "A200"},
            "hopeless" : {"colorShade": "BlueGrey", "colorType": "200"},
            "energetic": {"colorShade": "DeepPurple", "colorType": "A200"},
            "tired" : {"colorShade": "Lime", "colorType": "200"},
            "confident" : {"colorShade": "Pink", "colorType": "A200"},
            "insecure" : {"colorShade": "Green", "colorType": "200"},
            "relaxed" : {"colorShade": "Indigo", "colorType": "A200"},
            "stressed" : {"colorShade": "Amber", "colorType": "200"},
            "grateful": {"colorShade": "Purple", "colorType": "A200"},
            "disappointed" : {"colorShade": "Green", "colorType": "200"},
            "extroverted" : {"colorShade": "Red", "colorType": "A200"},
            "withdrawn" : {"colorShade": "Yellow", "colorType": "200"},
            "empathetic" : {"colorShade": "LightBlue", "colorType": "A200"},
            "carefree" : {"colorShade": "Pink", "colorType": "200"},
            "focused": {"colorShade": "Yellow", "colorType": "A200"},
            "chaotic" : {"colorShade": "Blue", "colorType": "200"},
            "inspired" : {"colorShade": "Teal", "colorType": "A200"},
            "unchallenged" : {"colorShade": "Purple", "colorType": "200"},
            "effective" : {"colorShade": "Orange", "colorType": "A200"},
            "frustrated" : {"colorShade": "BlueGrey", "colorType": "200"},
          }
        },
        activityColors: {
          type: Object,
          value: 
            { "Sleep": {"colorShade": "Teal", "colorType": "A200"},
              "Work1" : {"colorShade": "Blue", "colorType": "A200"},
              "Work2" : {"colorShade": "Purple", "colorType": "A200"},
              "Exercise" : {"colorShade": "Orange", "colorType": "A200"},
              "Social" : {"colorShade": "Pink", "colorType": "A200"},
              "Errands" : {"colorShade": "Purple", "colorType": "A200"},
              "Personal": {"colorShade": "Green", "colorType": "A200"}
            }
        },
      },
      observers: [
        'dataChanged(dailydb.*)',
      ],
      getActivityColor: function(activityName) {
          var colorSheet = this.$.colorSheet;
          var colorShadeString = this.activityColors[activityName].colorShade;
          var colorGradientString = this.activityColors[activityName].colorType;
          var selectedColor = colorSheet.colors[colorShadeString][colorGradientString];
          return selectedColor;        
      },
      getEmotionColor: function(emotionName){
          var colorSheet = this.$.colorSheet;
          var colorShadeString = this.emotionColors[emotionName].colorShade;
          var colorGradientString = this.emotionColors[emotionName].colorType;
          var selectedColor = colorSheet.colors[colorShadeString][colorGradientString];
          return selectedColor;
      },
      ready: function() {
        /*eslint-disable */

        this.names = (this.activities).concat(this.emotions);

        var activityColorsList = [];
        for (var i = 0; i < this.activities.length; i++) {
          activityColorsList.push(this.getActivityColor(this.activities[i]));
        }
        var emotionColorsList = [];
        for (var i = 0; i < this.emotions.length; i++) {
          emotionColorsList.push(this.getEmotionColor(this.emotions[i]));
        }
        var color  = (activityColorsList).concat(emotionColorsList);
        // for (var i = 0; i < this.names.length; i++) {
        //     this.data.push(this.createEmptyEvent(this.names[i]));
        // }
        console.log("DEFINING COLOR");
        console.log(color);
        
      },
       createEmptyEvent: function(name) {
            var event = [];

            return event;
        },
      dataChanged: function (dailydb) {
        var that = this;
        // do something when the query returns values
        console.log("---BEFORE ANALYSIS");
        var dataRaw = this.dailydb;
        console.log("dailydb");
        console.log(dataRaw);
        console.log("this.data");
        console.log(this.data);
        
        this.names = (this.activities).concat(this.emotions);
        
        var activityColorsList = [];
        for (var i = 0; i < this.activities.length; i++) {
          activityColorsList.push(this.getActivityColor(this.activities[i]));
        }
        var emotionColorsList = [];
        for (var i = 0; i < this.emotions.length; i++) {
          emotionColorsList.push(this.getEmotionColor(this.emotions[i]));
        }
        var color  = (activityColorsList).concat(emotionColorsList);

        this.dataList = [];
        for (var i = 0; i < this.names.length; i++) {
            this.dataList.push([]);
        }

        dataRaw.forEach(function(childSnapshot) {
          var dateString = childSnapshot.$key;
          var date = dateString;
          console.log("childSnapshot");
          console.log(childSnapshot);
          for (var key in childSnapshot) {
            console.log("key");
            console.log(key);
             // || key === "emotions"
            if (key === "activities") {
              var childChildSnapshot = childSnapshot[key];
              console.log("childChildSnapshot");
              console.log(childChildSnapshot);
              for (var keyChild in childChildSnapshot) {
                var name = keyChild;
                var childKey = childChildSnapshot[keyChild];
                var value;
                console.log("childKey: ");
                console.log(childKey);
                if (key === "activities") {
                  value = childKey;
                }
                else {
                  value = childKey.value;
                }
                var entry = {"key": name, "value": value, "date": date};
                console.log(entry);
                var index = that.names.indexOf(name);
                console.log("index");
                console.log(index);
                that.dataList[index].push(entry);
                console.log("that.dataList");
                console.log(that.dataList);                
              }
            } 
          }
        });
        console.log("dataChanged");
        this.data = [];
        console.log(this.dataList);
        console.log("START this.data");
        console.log(this.data);
        for (list in this.dataList) {
          console.log("list");
          console.log(this.dataList[list]);
          console.log("this.data");
          console.log(this.data);
          this.data = this.data.concat(this.dataList[list]);
        }
        console.log("END this.data");
        console.log(this.data);
        // Date date = new SimpleDateFormat("EEE MMM dd yyyy").parse(s);
        this.$.charts.readyProduce();
      }
    });

  </script>

</dom-module>